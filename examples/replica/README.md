# MongoDB Replica Set example

**WARNING:**

**This is only a Proof-Of-Concept example and it is not meant to be used in any
production. Use at your own risk.**

## What is MongoDB Replica Set?

A cluster of MongoDB servers that implements master-slave replication and automated failover.
MongoDBâ€™s recommended replication strategy.

## Deployment:

To create MongoDB replica set in OpenShift v3, you can use the example template
included in this repository:

* `oc create -f ./2.4/examples/replica/mongodb-clustered.json`

## How does it work?

### Service 'mongodb'

This resource defines a headless Kubernetes Service that serve as an entrypoint
to the MongoDB cluster. The Service endpoints are the Pods created by the
MongoDB replication controller.

Having 'headless' Service means that the `portalIP` attribute of this Service is
set to `None`. This allows to use DNS queries to discover other MongoDB
endpoints from inside the container, by quering the Service name (eg. `dig
mongodb A +short +search`).

### Pod 'mongodb-service'

This pod is responsible for initializing the MongoDB replica set. It runs just
once when the resources are being created for the first time. It also creates
the initial database and users. After the initialization is completed and data
are replicated to other member of MongoDB replication set, this pod gives up the
PRIMARY role in the replica set and shutdown.

### DeploymentConfig 'mongodb'

This resource defines the replication controller template that manages the
MongoDB replication member. Each member starts the MongoDB server without
replication data. Once the member is available, it advertises itself to the
current MongoDB replication set PRIMARY member, which will then add it into the
replication set.
When this member is destroyed, it will also remove itself from the existing
MongoDB replication set.

To add/remove more MongoDB pods to replica set you can use `oc scale` command.
The following command will scale the MongoDB replication controller up to 4 pods:

```
$ oc scale rc mongodb-1 --replicas=4
```

The provided `mongodb_replica_set.json` example will start three MongoDB replicas
by default.

## Settings and Security

There are few environment variables that users need to set in order to create
the MongoDB replSet:

For the 'mongodb-service' Pod, you have to set following variables:

* `MONGODB_REPLICA_NAME` - the name of the replSet (default: `rs0`).
* `MONGODB_SERVICE_NAME` - the name of the MongoDB Service (used to DNS lookup, default: 'mongodb').
* `MONGODB_ADMIN_PASSWORD` - the password for the 'admin' user (Generated by default).
* `MONGODB_USER` - the name of the regular MongoDB user (Generated by default).
* `MONGODB_PASSWORD` - the regular MongoDB user password (Generated by default).
* `MONGODB_KEYFILE_VALUE` - value for 'keyFile[1](http://docs.mongodb.org/manual/tutorial/generate-key-file)' file that MongoDB members use for authorization internally (Generated by default).

All the expressions, from which values of the environment variables are generated,
are defined in `mongodb_replica_set.json`

For the 'mongodb-1' scaled Pods, you have to set following variables (they have to match the variables above):

* `MONGODB_REPLICA_NAME`
* `MONGODB_SERVICE_NAME`
* `MONGODB_ADMIN_PASSWORD`
* `MONGODB_KEYFILE_VALUE`

## Teardown the cluster
For deleting all the created resources use:

```
$ oc delete all --all
```
